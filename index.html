<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¡—æ–™åœ¨åº«ç®¡ç†</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <style>
    body { font-family: sans-serif; margin: 1em; background: #f4f4f4; }
    h1 { text-align: center; }
    .form-group, .search-group { margin-bottom: 1em; }
    label { display: block; margin-bottom: 0.2em; }
    input, select, button {
      padding: 0.5em;
      margin-bottom: 0.5em;
    }
    input[type="text"], input[type="number"], select {
      width: 25%;
    }
    button { width: auto; }
    .card {
      background: white;
      padding: 1em;
      margin-bottom: 1em;
      border-radius: 0.5em;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .controls button { width: auto; margin-right: 0.5em; }
    #authButtons { text-align: center; margin: 1em 0; }
  </style>
</head>
<body>
  <h1>å¡—æ–™åœ¨åº«ç®¡ç†</h1>

  <div id="authButtons">
    <button id="signin-button" onclick="handleAuthClick()">ğŸ” Googleãƒ­ã‚°ã‚¤ãƒ³</button>
    <button id="signout-button" onclick="handleSignoutClick()" style="display:none;">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    <button id="drive-button" onclick="saveToDrive()" style="display:none;">â˜ Driveã«ä¿å­˜</button>
  </div>

  <div class="form-group">
    <label for="code">ã‚«ãƒ©ãƒ¼ç•ªå·</label>
    <input id="code" type="text" />
    <label for="colorName">è‰²å</label>
    <input id="colorName" type="text"/>
    <label for="maker">ãƒ¡ãƒ¼ã‚«ãƒ¼</label>
    <input id="maker" type="text"/>
    <label for="type">ç¨®é¡</label>
    <select id="type">
      <option value="ãƒ©ãƒƒã‚«ãƒ¼">ãƒ©ãƒƒã‚«ãƒ¼</option>
      <option value="æ°´æ€§">æ°´æ€§</option>
      <option value="ã‚¨ãƒŠãƒ¡ãƒ«">ã‚¨ãƒŠãƒ¡ãƒ«</option>
    </select>
    <label for="finish">ä»•ä¸Šã’</label>
    <select id="finish">
      <option value="è‰¶ã‚ã‚Š">è‰¶ã‚ã‚Š</option>
      <option value="åŠå…‰æ²¢">åŠå…‰æ²¢</option>
      <option value="è‰¶ãªã—">è‰¶ãªã—</option>
      <option value="ãƒ¡ã‚¿ãƒªãƒƒã‚¯">ãƒ¡ã‚¿ãƒªãƒƒã‚¯</option>
    </select>
    <label for="count">æ‰€æŒæ•°</label>
    <input id="count" type="number" value="1" min="1"/>
    <button onclick="addColor()">ï¼‹ ã‚«ãƒ©ãƒ¼ã‚’è¿½åŠ </button>
    <button onclick="exportCSV()">CSVå‡ºåŠ›</button>
  </div>

  <div class="search-group">
    <input id="searchQuery" type="text" placeholder="è‰²åã‚„ãƒ¡ãƒ¼ã‚«ãƒ¼ã§æ¤œç´¢"/>
    <select id="searchType">
      <option value="">å…¨ç¨®é¡</option>
      <option value="ãƒ©ãƒƒã‚«ãƒ¼">ãƒ©ãƒƒã‚«ãƒ¼</option>
      <option value="æ°´æ€§">æ°´æ€§</option>
      <option value="ã‚¨ãƒŠãƒ¡ãƒ«">ã‚¨ãƒŠãƒ¡ãƒ«</option>
    </select>
    <button onclick="renderList()">æ¤œç´¢</button>
  </div>

  <div id="paintList"></div>

  <script>
    let paints = JSON.parse(localStorage.getItem('paints') || '[]');

    function save() {
      localStorage.setItem('paints', JSON.stringify(paints));
    }

    function addColor() {
      const code = document.getElementById('code').value;
      const name = document.getElementById('colorName').value;
      const maker = document.getElementById('maker').value;
      const type = document.getElementById('type').value;
      const finish = document.getElementById('finish').value;
      const count = parseInt(document.getElementById('count').value);
      if (!name || !maker || count < 1) return;
      paints.push({ code, name, maker, type, finish, count });
      save();
      renderList();
    }

    function changeCount(index, delta) {
      paints[index].count = Math.max(0, paints[index].count + delta);
      save();
      renderList();
    }

    function deleteColor(index) {
      if (confirm('ã“ã®ã‚«ãƒ©ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        paints.splice(index, 1);
        save();
        renderList();
      }
    }

    function editColor(index) {
      const p = paints[index];
      document.getElementById('code').value = p.code || '';
      document.getElementById('colorName').value = p.name;
      document.getElementById('maker').value = p.maker;
      document.getElementById('type').value = p.type;
      document.getElementById('finish').value = p.finish;
      document.getElementById('count').value = p.count;
      paints.splice(index, 1);
      save();
      renderList();
    }

    function exportCSV() {
      const csvRows = [['ã‚«ãƒ©ãƒ¼ç•ªå·','è‰²å','ãƒ¡ãƒ¼ã‚«ãƒ¼','ç¨®é¡','ä»•ä¸Šã’','æ‰€æŒæ•°']];
      paints.forEach(p => csvRows.push([p.code || '', p.name, p.maker, p.type, p.finish, p.count]));
      const csvContent = '\uFEFF' + csvRows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'paints.csv';
      a.click();
    }

    function renderList() {
      const query = document.getElementById('searchQuery').value.toLowerCase();
      const typeFilter = document.getElementById('searchType').value;
      const container = document.getElementById('paintList');
      container.innerHTML = '';
      paints.forEach((p, i) => {
        if (
          (query && !p.name.toLowerCase().includes(query) && !p.maker.toLowerCase().includes(query)) ||
          (typeFilter && p.type !== typeFilter)
        ) return;
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <strong>${p.code || ''} ${p.name}</strong>ï¼ˆ${p.maker}ï¼‰<br>
          ${p.type}ï½œ${p.finish}ï½œæ‰€æŒæ•°ï¼š${p.count}<br>
          <div class="controls">
            <button onclick="changeCount(${i}, 1)">ï¼‹</button>
            <button onclick="changeCount(${i}, -1)">âˆ’</button>
            <button onclick="editColor(${i})">ä¿®æ­£</button>
            <button onclick="deleteColor(${i})">å‰Šé™¤</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    renderList();

    // Google Driveé€£æº
    const CLIENT_ID = '1003259273103-dsa7me0d41eqs0tkvqlu1fr5b3qc3m1d.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    function initClient() {
      gapi.client.init({ clientId: CLIENT_ID, scope: SCOPES }).then(() => {
        const authInstance = gapi.auth2.getAuthInstance();
        updateSigninStatus(authInstance.isSignedIn.get());
        authInstance.isSignedIn.listen(updateSigninStatus);
      });
    }

    function updateSigninStatus(isSignedIn) {
      document.getElementById('signin-button').style.display = isSignedIn ? 'none' : '';
      document.getElementById('signout-button').style.display = isSignedIn ? '' : 'none';
      document.getElementById('drive-button').style.display = isSignedIn ? '' : 'none';
    }

    function handleAuthClick() {
      gapi.auth2.getAuthInstance().signIn();
    }

    function handleSignoutClick() {
      gapi.auth2.getAuthInstance().signOut();
    }

    function saveToDrive() {
      const csvRows = [['ã‚«ãƒ©ãƒ¼ç•ªå·','è‰²å','ãƒ¡ãƒ¼ã‚«ãƒ¼','ç¨®é¡','ä»•ä¸Šã’','æ‰€æŒæ•°']];
      paints.forEach(p => csvRows.push([p.code || '', p.name, p.maker, p.type, p.finish, p.count]));
      const content = '\uFEFF' + csvRows.map(r => r.join(',')).join('\n');
      const file = new Blob([content], { type: 'text/csv' });
      const metadata = {
        name: 'å¡—æ–™åœ¨åº«.csv',
        mimeType: 'text/csv'
      };

      const accessToken = gapi.auth.getToken().access_token;
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', file);

      fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: new Headers({ Authorization: 'Bearer ' + accessToken }),
        body: form
      }).then(res => res.json()).then(val => {
        alert('Google Drive ã«ä¿å­˜ã—ã¾ã—ãŸ');
      });
    }

    window.onload = handleClientLoad;
  </script>
</body>
</html>
